#!/bin/bash
# Malware Detection Check
# Detects known malware, suspicious binaries, and encoded payloads

set -e

SKILL_PATH="$1"

if [ -z "$SKILL_PATH" ]; then
    echo "Usage: $0 <skill-path>"
    exit 1
fi

echo "=== MALWARE DETECTION CHECK ==="
echo "Scanning: $SKILL_PATH"
echo ""

FOUND=0

# Check 1: Known malicious domains
echo "Checking for known malicious domains..."
MALICIOUS_DOMAINS=(
    "openclawcli.vercel.app"
    "openclawcli"
    "amos"
    "atomic.*stealer"
)

for domain in "${MALICIOUS_DOMAINS[@]}"; do
    if grep -ri "$domain" "$SKILL_PATH" 2>/dev/null; then
        echo "üö® CRITICAL: Known malicious domain found: $domain"
        FOUND=1
    fi
done

# Check 2: Suspicious binary files
echo "Checking for suspicious binary files..."
BINARIES=$(find "$SKILL_PATH" -type f \( -name "*.exe" -o -name "*.dll" -o -name "*.so" -o -name "*.dylib" -o -name "*.bin" \) 2>/dev/null)

if [ -n "$BINARIES" ]; then
    echo "üö® CRITICAL: Binary files found:"
    echo "$BINARIES"
    FOUND=1

    # Check if Mach-O (macOS executable)
    for bin in $BINARIES; do
        if file "$bin" 2>/dev/null | grep -q "Mach-O"; then
            echo "üö® CRITICAL: Mach-O executable detected: $bin"
        fi
    done
fi

# Check 3: ZIP files containing executables
echo "Checking for ZIP files..."
ZIPS=$(find "$SKILL_PATH" -name "*.zip" -type f 2>/dev/null)

for zip in $ZIPS; do
    if unzip -l "$zip" 2>/dev/null | grep -E "\.(exe|dll|so|dylib|bin|sh)$"; then
        echo "üö® CRITICAL: ZIP contains executable: $zip"
        FOUND=1
    fi
done

# Check 4: Large base64 blobs (potential payload)
echo "Checking for encoded payloads..."
if grep -rE "base64.*[A-Za-z0-9+/]{100,}" "$SKILL_PATH" --include="*.sh" --include="*.js" --include="*.md" 2>/dev/null; then
    echo "‚ö†Ô∏è HIGH: Large base64 encoded content found (potential payload)"
    FOUND=1
fi

# Check 5: Download and execute patterns
echo "Checking for download-and-execute patterns..."
if grep -rE "(curl|wget|fetch).*\|(bash|sh|zsh)" "$SKILL_PATH" --include="*.sh" --include="*.js" 2>/dev/null; then
    echo "üö® CRITICAL: Download-and-execute pattern found"
    FOUND=1
fi

# Check 6: CVE-2026-25253 indicators
echo "Checking for CVE-2026-25253 indicators..."
if grep -r "OpenClawCLI\|openclawcli" "$SKILL_PATH" 2>/dev/null; then
    echo "üö® CRITICAL: CVE-2026-25253 indicator found"
    FOUND=1
fi

# Check 7: File type analysis
echo "Analyzing file types..."
for file in $(find "$SKILL_PATH" -type f ! -name "*.md" ! -name "*.txt" ! -name "*.json" ! -name "*.js" ! -name "*.sh" ! -name "*.py" 2>/dev/null); do
    FILETYPE=$(file -b "$file" 2>/dev/null)
    if echo "$FILETYPE" | grep -qiE "executable|binary|Mach-O|ELF|PE32"; then
        echo "üö® CRITICAL: Unexpected executable file: $file ($FILETYPE)"
        FOUND=1
    fi
done

# Summary
echo ""
if [ $FOUND -eq 0 ]; then
    echo "‚úÖ PASS: No malware indicators detected"
else
    echo "‚ùå FAIL: Malware indicators detected"
fi

exit $FOUND
